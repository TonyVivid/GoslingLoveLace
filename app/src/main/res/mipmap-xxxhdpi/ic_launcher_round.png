package com.example.a1.version1;

import android.app.Activity;
import android.content.ContentResolver;
import android.content.ContentUris;
import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Build;
import android.os.Environment;
import android.os.Handler;
import android.os.Message;
import android.provider.DocumentsContract;
import android.provider.MediaStore;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.FrameLayout;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.RadioButton;
import android.widget.RadioGroup;
import android.widget.TabHost;
import android.widget.TextView;
import android.widget.Toast;

import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import trans_data.carriage;
import trans_data.carriageList;
import trans_data.chatInfo;
import trans_data.chatInfoList;
import trans_data.picture;

public class Home extends AppCompatActivity {
    chatadapter mychatadapter;
    stuffAdapter mystuffadapter;
    Handler myhandler;
    private TabHost tabHost;
    private List<chatInfo> infoarray=new ArrayList<>();
    private View home;
    private  View mine;
    private  View upload;
    private int messagesign=0; //判断是否有消息，有则为1，无则为0
    List<View> views = new ArrayList<>();
    private Intent intentMine=null;
    private int clickimg=0;//check which ImageView is clicked
    private int uploadmsg=0;//check whether it's time to upload info;
    private List<String> piclist =new ArrayList<>();
    private String [] picarray=new String[6];
    @Override
    protected void onPause() {
        if(getbackMessage!=null && getbackMessage.getStatus() == AsyncTask.Status.RUNNING){
            getbackMessage.cancel(true);
        }
        super.onPause();
    }
    @Override
protected  void onResume(){
        super.onResume();

    }
    protected void onCreate(Bundle savedInstanceState) {

        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_home2);
        tabHost = (TabHost) findViewById(android.R.id.tabhost);
        tabHost.setup();
        intentMine=new Intent();

        LayoutInflater layoutInflater = LayoutInflater.from(this);
         home=layoutInflater.inflate(R.layout.activity_stuff, tabHost.getTabContentView());
         mine=layoutInflater.inflate(R.layout.activity_mine, tabHost.getTabContentView());
         upload=layoutInflater.inflate(R.layout.upload, tabHost.getTabContentView());
        tabHost.addTab(tabHost.newTabSpec("").setIndicator("Home").setContent(R.id.stuff));
        tabHost.addTab(tabHost.newTabSpec("").setIndicator("Mine").setContent(R.id.mine));
        tabHost.addTab(tabHost.newTabSpec("").setIndicator("Upload").setContent(R.id.upload));

        initHome(home);

         myhandler =new Handler(){
            @Override
            public void handleMessage(Message msg) {
                super.handleMessage(msg);
                if(msg.what==555)
                {
                    Log.d("TAG","得到msg555");
                    initchat(mine);
                    getbackMessage.execute();

                }
                if(msg.what==556){
                    mychatadapter.notifyDataSetChanged();
                }
                if(msg.what==557){
                    new UploadStuff().start();
                }
                if(msg.what==558){
                    Log.d("TAG","重新初始化货物列表");
                    initHome(home);
                }
                if(msg.what==559){
                    Toast.makeText(getApplicationContext(),"the input is empty",Toast.LENGTH_SHORT).show();
                }

            }
        };
        new historythread().start();



    }
    class UploadStuff extends  Thread{
        public void run() {
            DataOutputStream out=((GlobalSocket)getApplication()).getOut();
            ObjectOutputStream objout=((GlobalSocket)getApplication()).getObjout();
            carriage mycarriage= new carriage();
            EditText txt_name= (EditText) findViewById(R.id.edt_name);
            EditText txt_price=(EditText)findViewById(R.id.edt_price);
            EditText txt_info=(EditText)findViewById(R.id.edt_info);
            String name=txt_name.getText().toString();
            String tempprice=txt_price.getText().toString();
            String info=txt_info.getText().toString();
            String owner=((GlobalSocket)getApplication()).getName();
            Log.d("TAG",name);
            if(name.equals("")||info.equals("")||tempprice.equals("")||picarray==null){
                Message msg=Message.obtain();
                msg.what=559;
                myhandler.sendMessage(msg);
                return;
            }
            else {
                List<picture> pictureList = new ArrayList<>();
                for (int i = 0; i < picarray.length; i++) {
                    picture pic = new picture();
                    if (picarray[i] != null) {
                        byte[] b = setData(picarray[i]);
                        pic.setPicData(b);
                        pic.setPicSize(b.length);
                        pic.setType(".jpg");
                        pic.setPicName(name);
                        pictureList.add(pic);
                    }
                }
                int price = Integer.valueOf(tempprice);
                mycarriage.setName(name);
                mycarriage.setNumber(owner);
                mycarriage.setOwner(owner);
                mycarriage.setPicture(pictureList);
                mycarriage.setPrice(price);
                mycarriage.setText(info);
                try {
                    out.writeInt(36);
                    objout.writeObject(mycarriage);
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }

        }
    }
    List<chatInfo> adjustInfoArray(List<chatInfo> list){
        // Iterator<chatInfo> iter = list.iterator();
        HashMap<String,String> tempmap=new HashMap<String,String>();
        List<chatInfo> mylist=new ArrayList<>();
        chatInfo info;
        for(int i=0;i< list.size();i++){
            info=list.get(i);
            String message=tempmap.get(info.getSender());
            if(message!=null){
                message=message+"\n"+info.getInfo();
                tempmap.put(info.getSender(),message);
            }
            else{
                tempmap.put(info.getSender(),info.getInfo());
            }
        }

        for(Map.Entry<String,String> entry : tempmap.entrySet()){
            chatInfo temp=new chatInfo();
            temp.setInfo(entry.getValue());
            Log.d("TAG",temp.getInfo());
            temp.setReceiver(((GlobalSocket) getApplication()).getName());
            temp.setSender(entry.getKey());
            mylist.add(temp);
        }
        return mylist;
    }
   void adjustInfoArray1(List<chatInfo> list){
        // Iterator<chatInfo> iter = list.iterator();
        HashMap<String,String> tempmap=new HashMap<String,String>();
        List<chatInfo> mylist=new ArrayList<>();
        chatInfo info;
        for(int i=0;i< list.size();i++){
            info=list.get(i);
            String message=tempmap.get(info.getSender());
            if(message!=null){
                message=message+"\n"+info.getInfo();
                tempmap.put(info.getSender(),message);
            }
            else{
                tempmap.put(info.getSender(),info.getInfo());
            }
        }

        for(Map.Entry<String,String> entry : tempmap.entrySet()){
            chatInfo temp=new chatInfo();
            temp.setInfo(entry.getValue());
            Log.d("TAG",temp.getInfo());
            temp.setReceiver(((GlobalSocket) getApplication()).getName());
            temp.setSender(entry.getKey());
            mylist.add(temp);
        }
       infoarray=mylist;
    }
    void initHome(View view){
        //final carriageList list=((GlobalSocket)getApplication()).getList();
         mystuffadapter=new stuffAdapter(this,R.layout.stuff_item,((GlobalSocket)getApplication()).getList().getList());
        ListView listview=(ListView)view.findViewById(R.id.list);
        listview.setAdapter(mystuffadapter);
        listview.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                Intent intent=new Intent();
                intent.setClass(Home.this,StuffInfo.class);
                carriageList list=((GlobalSocket)getApplication()).getList();
                carriage mycarriage=list.getList().get(position);
                //intent.putExtra("stuffinfo",mycarriage);
                intent.putExtra("stuffinfo",position);
                startActivity(intent);
            }
        });
    }
    class historythread extends  Thread{
        int type=0;

        chatInfoList clist=null;
        public void run() {
            Socket socket = ((GlobalSocket) getApplication()).getSocket();
            DataInputStream in = ((GlobalSocket) getApplication()).getIn();
            DataOutputStream out = ((GlobalSocket) getApplication()).getOut();
            ObjectOutputStream objout = ((GlobalSocket) getApplication()).getObjout();
            ObjectInputStream objin = ((GlobalSocket) getApplication()).getObjin();
            try {
                String name = ((GlobalSocket) getApplication()).getName();
                out.writeInt(35);
                out.writeUTF(name);
                type= in.readInt();
                Log.d("TAG","the message type:"+String.valueOf(type));
                if(type==446){
                    messagesign=1;
                    Log.d("TAg","here is 446 用户请求历史离线信息");
                    clist=(chatInfoList)objin.readObject();
                    infoarray=clist.getList();
                    Log.d("TAg","here is 446 用户得到了历史离线信息");
                    Message msg=Message.obtain();
                    msg.what=555;
                    myhandler.sendMessage(msg);
                    Log.d("TAg","here is 446 用户得到了历史离线信息");
                }
                if(type==447){
                    Message msg=Message.obtain();
                    msg.what=555;
                    myhandler.sendMessage(msg);
                    messagesign=0;
                    Log.d("TAG","there is no offline message");
                }
            } catch (Exception e) {
                e.printStackTrace();
            }

        }
    }
    class stuffAdapter extends ArrayAdapter {
        private final int sourceID;
        public stuffAdapter(Context context, int resourceID, List<carriage> list){
            super(context,resourceID,list);
            this.sourceID=resourceID;
        }
        public View getView(int position,  View convertView, ViewGroup parent) {
            carriage my_carriage=(carriage)getItem(position);
            View view = LayoutInflater.from(getContext()).inflate(sourceID, null);
            ImageView imgView=(ImageView)view.findViewById(R.id.img_stuff);
            TextView txtname=(TextView)view.findViewById(R.id.txt_name);
            TextView txtprice=(TextView)view.findViewById(R.id.txt_price);
            //Log.d("TAG",my_carriage.getOwner());
            txtname.setText(my_carriage.getName());
            String price=String.valueOf(my_carriage.getPrice());
            txtprice.setText(price);
            Bitmap firstphoto= BitmapFactory.decodeByteArray(my_carriage.getPicture().get(0).getPicData(),0,(int)my_carriage.getPicture().get(0).getPicSize());
            imgView.setImageBitmap(firstphoto);
            return view;
        }
    }
    void initchat(View view){
        Log.d("TAG","begin to init mine");
        //final List<chatInfo> list=((GlobalSocket)getApplication()).getInfo();
        //final List<chatInfo> list = ;
         mychatadapter=new chatadapter(this,R.layout.chatinfo_item,infoarray);
        ListView listview=(ListView)view.findViewById(R.id.list_chat);
        listview.setAdapter(mychatadapter);
        listview.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                Intent intent=new Intent();
                intent.setClass(Home.this,chat.class);
                intent.putExtra("chatinfo",infoarray.get(position));

                startActivity(intent);
            }
        });

    }
    class chatadapter extends  ArrayAdapter{
        private final int sourceID;
        public chatadapter(Context context, int resourceID, List<chatInfo> list){
            super(context,resourceID,list);
            this.sourceID=resourceID;
        }
        public View getView(int position,  View convertView, ViewGroup parent) {
            chatInfo info=(chatInfo)getItem(position);
            View view = LayoutInflater.from(getContext()).inflate(sourceID, null);
            ImageView imgView=(ImageView)view.findViewById(R.id.img_user);
            TextView txtname=(TextView)view.findViewById(R.id.txt_name);
            TextView txtinfo=(TextView)view.findViewById(R.id.txt_info);
            txtname.setText(info.getSender());
            txtinfo.setText(info.getInfo());
            return view;
        }
    }
    AsyncTask<Void,String,Void> getbackMessage=new AsyncTask<Void, String, Void>() {

        @Override
        protected Void doInBackground(Void... voids) {

            DataInputStream in= ((GlobalSocket)getApplication()).getIn();
            DataOutputStream out=((GlobalSocket)getApplication()).getOut();
            ObjectInputStream objin=((GlobalSocket)getApplication()).getObjin();
            ObjectOutputStream objout=((GlobalSocket)getApplication()).getObjout();
            int type=0;

            try {
                while(true) {

                    if(isCancelle